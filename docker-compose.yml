name: mwe
services:
    resource-hub-db:
        container_name: resource-hub-db
        restart: always
        env_file:
            - .env
        build:
            context: .
            dockerfile: ResourceHubDB.Dockerfile
        expose:
            - '27017'
        ports:
            - 27017:27017
        volumes:
            - 'resource-hub-db-volume:/Users/vycos-zen/data/resource-hub-db-volume'
        environment:
            MONGO_INITDB_DATABASE: ${MONGO_DB}
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    resource-hub-api:
        container_name: resource-hub-api
        depends_on:
            - resource-hub-db
        restart: 'no'
        env_file:
            - .env
        build:
            context: .
            dockerfile: ResourceHubApi.Dockerfile
        expose:
            - '4000'
        ports:
            - 4000:4000
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://resource-hub-api:4000/health']
            interval: 10s
            timeout: 5s
            retries: 5

    mwe-sleeping-dragon-ui:
        container_name: mwe-sleeping-dragon-ui
        build:
            context: .
            dockerfile: ResourceHubUI.Dockerfile
        depends_on:
            - resource-hub-api
        expose:
            - '3000'
        ports:
            - 3000:3000
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000']
            interval: 10s
            timeout: 5s
            retries: 5
        environment:
            NODE_ENV: production

    resource-hub-gateway:
        container_name: resource-hub-gateway
        env_file:
            - .env
        depends_on:
            mwe-sleeping-dragon-ui:
                condition: service_healthy
            resource-hub-api:
                condition: service_started
        build:
            context: .
            dockerfile: ResourceHubGateway.Dockerfile
            args:
                NGINX_PORT: ${NGINX_PORT}
                MWE_HOST: ${MWE_HOST}
        platform: linux/amd64
        expose:
            - '${NGINX_PORT}'
        ports:
            - ${NGINX_PORT}:${NGINX_PORT}
            - ${NGINX_PORT}:443/udp
        volumes:
            - ./apps-ui/mwe-friday-ui/dist:/base/static:ro

volumes:
    resource-hub-db-volume:
        driver: local
